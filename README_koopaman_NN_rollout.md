# Latent Space Dynamics Modeling

This document describes how to model the temporal evolution of latent space embeddings using two different methods: a linear Koopman operator and a non-linear neural network propagator. These scripts operate on time-series data, such as the `pooled_embedding.h5` file generated by the autoencoder.

After a model is trained, both scripts will always perform a predictive "rollout" for the *entire* trajectory, starting from the true 0th embedding. This allows for direct comparison between the model's prediction and the ground truth.

---

## 1. Linear Dynamics with a Koopman Operator

This method fits a single linear matrix `A` that approximates the system's dynamics according to `z_{t+1} ≈ A * z_t`. It uses Dynamic Mode Decomposition (DMD), a data-driven method to find the best-fit linear operator. This approach is fast and provides an interpretable model.

### How to Run

**Example (Train on 80% of data, rank 20, with noise in the rollout):**
```bash
python fit_koopman_model.py --train_fraction 0.8 --svd_rank 20 --rollout_noise_std 0.01
```

### Key Arguments

*   `--h5_file`: (Optional) Path to the HDF5 file containing the latent space embeddings (e.g., `pooled_embedding.h5` generated by an autoencoder). This file serves as the input time-series data for dynamics modeling. Defaults to `latent_reps/pooled_embedding.h5`.
*   `--train_fraction`: (Optional) The fraction of the input time-series data to use for training the Koopman operator. The remaining data can be used for validation or testing. Defaults to `1.0` (all data).
*   `--svd_rank`: (Optional) A crucial parameter for de-noising and dimensionality reduction. It specifies the number of dominant singular values (modes) to retain when performing Singular Value Decomposition (SVD) during the Koopman operator fitting. A lower rank can help filter noise and capture the most significant dynamics. If omitted, the full r>
*   `--rollout_noise_std`: (Optional) Standard deviation of Gaussian noise to add at each step of the predictive rollout. This can be used to simulate stochasticity in the dynamics or explore the model's robustness to perturbations. Defaults to `0.0` (deterministic).
*   `--output_file`: (Optional) Path to save the learned Koopman operator matrix (`A`) as a NumPy array. This allows for later inspection or reuse of the trained model. Defaults to `koopman_operator.npy`.

### Outputs

*   `koopman_operator.npy`: The learned Koopman matrix `A`.
*   `..._eigenvalues.npy` & `..._modes.npy`: Files containing the eigenvalues and dynamic modes of the operator.
*   `latent_reps/koopman_rollout_... .h5`: An HDF5 file containing the full predicted trajectory.

---

## 2. Non-Linear Dynamics with a Neural Network Propagator

This method trains a neural network to learn the potentially non-linear function `f` that maps the state at time `t` to the state at time `t+1`, such that `z_{t+1} ≈ f(z_t)`. This approach is more powerful and can capture more complex dynamics.

### How to Run

**Example (Train on 80% of data, predict 5 frames ahead, with noise):**
```bash
python train_neural_propagator.py --train_fraction 0.8 --frame_skip 5 --rollout_noise_std 0.01
```

### Key Arguments

*   `--h5_file`: (Optional) Path to the HDF5 file containing the latent space embeddings (e.g., `pooled_embedding.h5` generated by an autoencoder). This file serves as the input time-series data for training the neural network propagator. Defaults to `latent_reps/pooled_embedding.h5`.
*   `--train_fraction`: (Optional) The fraction of the input time-series data to use for training the neural network. The remainder is used for validation to monitor overfitting. Defaults to `0.8`.
*   `--frame_skip`: (Optional) The number of frames (time steps) to predict into the future (`z_{t+n}`). A larger value means the network learns to predict further ahead, which can help capture long-range dependencies in the dynamics but might also make training more challenging. Defaults to `1`.
*   `--rollout_noise_std`: (Optional) Standard deviation of Gaussian noise to add at each step of the predictive rollout. Similar to the Koopman model, this can be used to simulate stochasticity or test robustness. Defaults to `0.0` (deterministic).
*   `--epochs`: (Optional) The number of training epochs. This determines how many times the entire training dataset will be passed through the neural network. More epochs can lead to better learning but also risk overfitting. Defaults to `100`.
*   `--output_model_path`: (Optional) Path to save the trained neural network model's weights (state dictionary) in PyTorch's `.pth` format. This allows for loading and reusing the trained propagator. Defaults to `neural_propagator.pth`.

### Outputs

*   `neural_propagator.pth`: The saved state dictionary of the best-performing trained PyTorch model.
*   `latent_reps/nn_rollout_... .h5`: An HDF5 file containing the full predicted trajectory.

